#!/bin/sh
# Run this from the directory below where you extracted perl
# and applied the patches/GOOD/UPSTREAM/CVE-2016-1238.patch
# (and _extras.patch most likely)

find perl-5* -type d -exec chmod u+w {} \;
find perl-5* -name '*.orig' -exec rm -f {} \+

cd perl-5*/obj

# This line may need some adjusting.
~/OpenBSD-perl/bin/CVE-2016-1238/fix_versions.pl

export LD_LIBRARY_PATH=`pwd`:$LD_LIBRARY_PATH; cd t
chmod u+w ../../perl-5*/t/porting{,/customized.dat}
if  [ ! -e porting/customized.dat.orig ]; then
	cp ../../perl-5*/t/porting/customized.dat porting/customized.dat.orig
fi
./perl harness porting/customized.t
./perl porting/customized.t --regen
./perl harness porting/customized.t

cd ../

find . -name '*.orig' | (
    while read o; do
        diff -uNp $o ${o%.orig}
    done
) > ../CVE.patch
