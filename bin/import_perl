#!/bin/sh
# Some of this was based on portimport

BINDIR=$( readlink -f $(dirname $0) )
. $BINDIR/utils.sub

# Keeps me from accidentially committing someplace I shouldn't
CVSROOT=

setup_cvsroot

PERLCVS=src/gnu/usr.bin/perl

# Now we need a clean version of perl, fresh from the vendor
do_extract_perl

# Copy the clean version to use for the import
rm -rf ${PERL_BASE}.dist
cp -r $PERL_BASE ${PERL_BASE}.dist

# Put unicore off until later
mv $SRCDIR/patches/GOOD/pre_built_unicore.patch ${WRKDIR} || exit
trap "mv ${WRKDIR}/pre_built_unicore.patch $SRCDIR/patches/GOOD/" 0 1 2 15

# Apply our local patches
cd $PERL_BASE
do_patch_perl
cd $OLDPWD

# remove any patch cruft
find $PERL_BASE \( -name '*.orig' \) -exec rm -f {} \+

# Import vendor version perl
TAG=`echo $PERL_BASE | tr 'a-z.-' 'A-Z_'`
if [ -n "$AUTOCOMMIT" ]; then
    cd ${PERL_BASE}.dist
    cvs import -kb -m"Import $PERL_BASE" $PERLCVS PERL $TAG
    cd $OLDPWD
else
    echo "Ready to import, use this command, then fg to continue:"
    echo cd ${PERL_BASE}.dist
    echo "cvs -d $CVSROOT import -kb -m\"Import $PERL_BASE\" $PERLCVS PERL $TAG"
    echo cd \$OLDPWD
    kill -STOP $$
fi

# Checkout the tree to fix the merge errors
cvs checkout -jPERL:yesterday -jPERL $PERLCVS
chmod -R u+w $PERLCVS

# Get us even with vendor perl
SKIP_FILES=1 SKIP_UNICORE_PATCH=1 cvs_rm_add ${PERL_BASE}.dist $PERLCVS

if [ -n "$AUTOCOMMIT" ]; then
    cvs commit -m"Fix merge issues, remove excess files - match $PERL_BASE dist" $PERLCVS
else
    echo "Verify we match upstream, commit, and fg to continue"
    echo "cvs -d $CVSROOT commit $PERLCVS"
    kill -STOP $$
fi

# Add patches and remove anything we removed
SKIP_UNICORE_PATCH=1 cvs_rm_add $PERL_BASE $PERLCVS

# Verify it looks good, then cvs commit
if [ -n "$AUTOCOMMIT" ]; then
    cvs commit -m"Apply local patches, remove excess files - $PERL_BASE" $PERLCVS
else
    echo "Verify local patches look good, then commit and fg to continue"
    echo "cvs -d $CVSROOT commit $PERLCVS"
    kill -STOP $$
fi

for f in $( cd $SRCDIR/files && find . -type f ); do
    cp $PERLCVS/$f $PERL_BASE/$f
    #cp $PERLCVS/$f $SRCDIR/files/$f
done

# Now apply unicore patches
patch -fEp0 -d $PERL_BASE -i ${WRKDIR}/pre_built_unicore.patch

# remove any patch cruft
find $PERL_BASE \( -name '*.orig' \) -exec rm -f {} \+

# Add unicore patches and remove anything we removed
cvs_rm_add $PERL_BASE $PERLCVS

# Verify it looks good, then cvs commit
if [ -n "$AUTOCOMMIT" ]; then
    cvs commit -m"Apply pre-built unicore patch, remove excess files - $PERL_BASE" $PERLCVS
else
    echo "Verify unicore look good, then commit and fg to continue"
    echo "cvs -d $CVSROOT commit $PERLCVS"
    kill -STOP $$
fi


cd $PERLCVS
cvs up -PAd
cd $OLDPWD

mv ${PERLCVS%%/*} ${PERLCVS%%/*}.imported
cvs checkout -P $PERLCVS

set -x
diff -x CVS -ru $PERL_BASE $PERLCVS
