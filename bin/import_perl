#!/bin/sh
# Some of this was based on portimport

BINDIR=$( readlink -f $(dirname $0) )
. $BINDIR/utils.sub

# Keeps me from accidentially committing someplace I shouldn't
CVSROOT=

# Extract a relatively up-to-date perl cvs tree
# This file was generated by having a cvsync'd tree and
# cd /path/to/cvsynced/root/ && tar czvf ~/openbsd-cvs-src.tar.gz CVSROOT src 
if [ ! "$CVSROOT" ]; then
    [ -e cvs ] && mkdir old && mv cvs old && rm -rf old &
    tar xzf $BINDIR/../openbsd-cvs-src.tar.gz
    CVSROOT=${PWD}/cvs

    # avoid trying to send email
    for f in commit_prep{,2} log_accum{,2}; do
        echo "#!/usr/bin/true" > $CVSROOT/CVSROOT/$f
    done
fi

export CVSROOT
PERLCVS=src/gnu/usr.bin/perl

# Now we need a clean version of perl, fresh from the vendor
do_extract_perl

# Copy the clean version to use for the import
cp -r $PERL_BASE ${PERL_BASE}.dist

# Apply our local patches
cd $PERL_BASE
do_patch_perl
cd $OLDPWD

# remove any patch cruft
find $PERL_BASE \( -name '*.orig' \) -exec rm -f {} \+


# Import vendor version perl
TAG=`echo $PERL_BASE | tr 'a-z.-' 'A-Z_'`
cmd="cvs -d $CVSROOT import -kb -m\"Import $PERL_BASE\" $PERLCVS PERL $TAG"
if [ -n "$AUTOCOMMIT" ]; then
    cd ${PERL_BASE}.dist
    $cmd
    cd $OLDPWD
else
    echo "Ready to import, use this command, then fg to continue:"
    echo cd ${PERL_BASE}.dist
    echo $cmd
    echo cd \$OLDPWD
    kill -STOP $$
fi

cd $OLDPWD

# Checkout the tree to fix the merge errors
cvs checkout -jPERL:yesterday -jPERL $PERLCVS

# Remove merge cruft, we know what we want
find $PERLCVS -name '.#*' -exec rm -f {} \+

# remove any files that are not in the new perl
cd $PERLCVS
find . \( -type f -o -path '*/CVS' -prune \) \
    ! -name CVS \
    ! -exec test -e $OLDPWD/$PERL_BASE/{} \; \
  -exec cvs rm -f {} \;
cd $OLDPWD

# copy in the new files
cp -r $PERL_BASE/* $PERLCVS

# add any directories that aren't in CVS
find $PERLCVS \( -type d -o -path '*/CVS' -prune \) \
    ! -name CVS \
    ! -exec test -e {}/CVS \; \
  -exec cvs add {} \;

# Add any files that aren't in CVS
find $PERLCVS \( -type f -o -path '*/CVS' -prune \) \
    ! -name CVS \
    ! -execdir grep -q /{}/ CVS/Entries \; \
  -exec cvs add {} \;

# Verify it looks good, then cvs commit
if [ -n "$AUTOCOMMIT" ]; then
    cvs commit -m"Apply local patches, fix merge conflicts, remove excess files - ${PERL_BASE}" $PERLCVS
else
    echo "Verify local patches look good, then cvs commit and fg to continue"
    kill -STOP $$
fi
