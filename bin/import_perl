#!/bin/sh
# Some of this was based on portimport

BINDIR=$( readlink -f $(dirname $0) )
. $BINDIR/utils.sub

# Keeps me from accidentially committing someplace I shouldn't
CVSROOT=

user=$(id -un)
timestamp=$(date '+%Y%m%d')


# Extract a relatively up-to-date perl cvs tree
# This file was generated by having a cvsync'd tree and
# cd /path/to/cvsynced/root/ && tar czvf ~/openbsd-cvs-src.tar.gz CVSROOT src 
if [ ! "$CVSROOT" ]; then
    [ -e cvs ] && mkdir old && mv cvs old && rm -rf old &
    tar xzf ~/openbsd-cvs-src.tar.gz
    CVSROOT=${PWD}/cvs
fi

export CVSROOT
PERLCVS=src/gnu/usr.bin/perl

TAG=`echo $PERL_BASE | tr 'a-z.-' 'A-Z_'`

# Now we need a patched version of perl
do_extract_perl
cd $PERL_BASE

# Import a "clean" perl
cvs import -m"Import $PERL_BASE" $PERLCVS PERL $TAG

# Apply our local patches
do_patch_perl

cd $OLDPWD

# Checkout the tree to fix the merge errors
cvs checkout -jPERL:yesterday -jPERL src/gnu/usr.bin/perl

# remove any patch cruft
find $PERL_BASE \( -name '*.orig' \) -exec rm -f {} \+

# remove any files that are not in the new perl
cd $PERLCVS
find . \( \( -type f -o -path '*/CVS' -prune \) ! -name CVS \
    ! -exec test -e $OLDPWD/$PERL_BASE/{} \; \) -exec cvs rm -f {} \;
cd $OLDPWD

# copy in the new files
cp -r $PERL_BASE/* $PERLCVS

# add any directories that aren't in CVS
find $PERLCVS \( -type d -o -path '*/CVS' -prune \) \
    ! -name CVS ! -name '.#*' \
    ! -exec test -e {}/CVS \; -exec cvs add {} \;

# Add any files that aren't in CVS
# TODO: rewrite this not to require a local $CVSROOT
find $PERLCVS \( \( -type f -o -path '*/CVS' -prune \) \
    ! -name CVS ! -name '.#*' \
    ! -exec test -e $CVSROOT/{},v \; \) -exec cvs add {} \;

# Verify it looks good, then cvs commit
